<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>IoT Sensor Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.2.0"></script>
    <style>
      /* ======== GENERAL LAYOUT ======== */
      body {
        font-family: "Poppins", sans-serif;
        margin: 0;
        background: linear-gradient(to bottom right, #e6f7ff, #cce7ff);
        color: #1a2a33;
        text-align: center;
        min-height: 100vh;
      }

      h1 {
        color: #007acc;
        margin-top: 30px;
      }

      p {
        color: #333;
        font-size: 1.1em;
      }

      /* ======== GRID CONTAINER ======== */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        width: 90%;
        max-width: 1000px;
        margin: 40px auto;
      }

      /* ======== CHART CONTAINERS ======== */
      .chart-container {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        box-shadow: 0px 4px 12px rgba(0, 122, 204, 0.15);
        padding: 20px;
        transition: transform 0.3s ease;
      }

      .chart-container:hover {
        transform: translateY(-4px);
      }

      .chart-container h2 {
        color: #007acc;
        margin-bottom: 15px;
      }

      /* ======== ALERT BOX ======== */
      #alerts {
        width: 90%;
        max-width: 900px;
        margin: 20px auto;
        padding: 15px;
        border-radius: 8px;
        background: #e3f2fd;
        border: 1px solid #90caf9;
        color: #0d47a1;
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>IoT Sensor Dashboard</h1>
    <p>Latest daily sensor readings (last 20 days)</p>

    <div id="alerts"></div>

    <!-- ======== CHARTS IN GRID ======== -->
    <div class="dashboard-grid">
      <div class="chart-container">
        <h2>Temperature (°C)</h2>
        <canvas id="tempChart"></canvas>
      </div>

      <div class="chart-container">
        <h2>Humidity (%)</h2>
        <canvas id="humidityChart"></canvas>
      </div>

      <div class="chart-container">
        <h2>Battery Voltage (V)</h2>
        <canvas id="batteryChart"></canvas>
      </div>

      <div class="chart-container">
        <h2>Motion Counts</h2>
        <canvas id="motionChart"></canvas>
      </div>
    </div>

    <script>
      const channelId = "3077306";
      const readApiKey = "RJKY2M6KAC4APH45";
      const results = 8000;

      const THRESHOLDS = {
        temperature: 15,
        humidity: 60,
        battery: 3.0,
      };

      let tempChart, humidityChart, batteryChart, motionChart;

      if ("Notification" in window) {
        Notification.requestPermission();
      }

      async function fetchThingSpeakData() {
        const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?api_key=${readApiKey}&results=${results}`;
        const response = await fetch(url);
        const data = await response.json();
        return data.feeds;
      }

      function getLastNDaysData(feeds, nDays = 20) {
        const grouped = {};
        feeds.forEach((feed) => {
          if (feed.created_at) {
            const date = new Date(feed.created_at);
            const day = date.toISOString().slice(0, 10);
            if (!grouped[day]) grouped[day] = [];
            grouped[day].push(feed);
          }
        });

        const sortedDays = Object.keys(grouped).sort().slice(-nDays);
        const timestamps = [];
        const temperature = [];
        const humidity = [];
        const battery = [];
        const motion = [];

        sortedDays.forEach((day) => {
          timestamps.push(day);
          const lastEntry = grouped[day][grouped[day].length - 1];
          temperature.push(parseFloat(lastEntry.field4) || 0);
          humidity.push(parseFloat(lastEntry.field2) || 0);
          battery.push(parseFloat(lastEntry.field1) || 0);
          motion.push(parseInt(lastEntry.field3) || 0);
        });

        return { timestamps, temperature, humidity, battery, motion };
      }

      function createBarChart(
        ctx,
        label,
        data,
        bgColor,
        borderColor,
        yMin = 0,
        yMax = null
      ) {
        return new Chart(ctx, {
          type: "bar",
          data: {
            labels: data.timestamps,
            datasets: [
              {
                label: label,
                data: data.values,
                backgroundColor: bgColor,
                borderColor: borderColor,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: true, position: "top" } },
            scales: {
              y: { beginAtZero: true, min: yMin, max: yMax },
              x: { ticks: { autoSkip: false } },
            },
          },
        });
      }

      function updateChart(chart, newLabels, newData) {
        chart.data.labels = newLabels;
        chart.data.datasets[0].data = newData;
        chart.update();
      }

      function showAlert(message) {
        const alertBox = document.getElementById("alerts");
        alertBox.style.display = "block";
        alertBox.innerHTML += `<p>⚠️ ${message}</p>`;
        if (Notification.permission === "granted") {
          new Notification("IoT Alert", { body: message });
        }
      }

      function clearAlerts() {
        const alertBox = document.getElementById("alerts");
        alertBox.style.display = "none";
        alertBox.innerHTML = "";
      }

      function checkThresholds(data) {
        const latestIndex = data.timestamps.length - 1;
        const temp = data.temperature[latestIndex];
        const hum = data.humidity[latestIndex];
        const bat = data.battery[latestIndex];

        if (temp < THRESHOLDS.temperature)
          showAlert(`Temperature is low: ${temp.toFixed(1)}°C`);
        if (hum < THRESHOLDS.humidity)
          showAlert(`Humidity is low: ${hum.toFixed(1)}%`);
        if (bat < THRESHOLDS.battery)
          showAlert(`Battery voltage is low: ${bat.toFixed(2)}V`);
      }

      async function renderCharts() {
        clearAlerts();
        const feeds = await fetchThingSpeakData();
        const last20 = getLastNDaysData(feeds, 20);
        checkThresholds(last20);

        if (!tempChart) {
          tempChart = createBarChart(
            document.getElementById("tempChart"),
            "Temperature (°C)",
            { timestamps: last20.timestamps, values: last20.temperature },
            "rgba(0,150,255,0.6)",
            "rgba(0,150,255,1)",
            0,
            40
          );
          humidityChart = createBarChart(
            document.getElementById("humidityChart"),
            "Humidity (%)",
            { timestamps: last20.timestamps, values: last20.humidity },
            "rgba(0,200,255,0.6)",
            "rgba(0,200,255,1)",
            0,
            100
          );
          batteryChart = createBarChart(
            document.getElementById("batteryChart"),
            "Battery Voltage (V)",
            { timestamps: last20.timestamps, values: last20.battery },
            "rgba(0,180,255,0.6)",
            "rgba(0,180,255,1)",
            0,
            5
          );
          motionChart = createBarChart(
            document.getElementById("motionChart"),
            "Motion Counts",
            { timestamps: last20.timestamps, values: last20.motion },
            "rgba(100,220,255,0.6)",
            "rgba(100,220,255,1)"
          );
        } else {
          updateChart(tempChart, last20.timestamps, last20.temperature);
          updateChart(humidityChart, last20.timestamps, last20.humidity);
          updateChart(batteryChart, last20.timestamps, last20.battery);
          updateChart(motionChart, last20.timestamps, last20.motion);
        }
      }

      // ======== INITIALIZE ========
      renderCharts();
      setInterval(renderCharts, 30000); // refresh every
    </script>
    <a href="{% url 'landing' %}" class="back-btn">← Back to Landing Page</a>
  </body>
</html>
